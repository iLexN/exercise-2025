<?php

declare(strict_types=1);
/**
 * Copyright (c) The Magic , Distributed under the software license
 */

namespace Dtyq\PhpMcp\Tests\Unit\Types\Requests;

use Dtyq\PhpMcp\Shared\Exceptions\ValidationError;
use Dtyq\PhpMcp\Types\Requests\CallToolRequest;
use PHPUnit\Framework\TestCase;

/**
 * Test case for CallToolRequest class.
 * @internal
 */
class CallToolRequestTest extends TestCase
{
    public function testConstructorWithValidData(): void
    {
        $name = 'test_tool';
        $arguments = ['param1' => 'value1', 'param2' => 123];
        $id = 'call_123';

        $request = new CallToolRequest($name, $arguments, $id);

        $this->assertSame('tools/call', $request->getMethod());
        $this->assertSame($name, $request->getName());
        $this->assertSame($arguments, $request->getArguments());
        $this->assertSame($id, $request->getId());
        $this->assertFalse($request->hasProgressToken());
        $this->assertNull($request->getProgressToken());
    }

    public function testConstructorWithAutoGeneratedId(): void
    {
        $name = 'test_tool';
        $request = new CallToolRequest($name);

        $this->assertIsString($request->getId());
        $this->assertStringStartsWith('call_tool_', $request->getId());
        $this->assertNull($request->getArguments());
    }

    public function testSetName(): void
    {
        $request = new CallToolRequest('initial_tool');

        $request->setName('updated_tool');
        $this->assertSame('updated_tool', $request->getName());
    }

    public function testSetNameWithEmptyString(): void
    {
        $request = new CallToolRequest('initial_tool');

        $this->expectException(ValidationError::class);
        $request->setName('');
    }

    public function testSetArguments(): void
    {
        $request = new CallToolRequest('test_tool');
        $arguments = ['key' => 'value', 'number' => 42];

        $request->setArguments($arguments);
        $this->assertSame($arguments, $request->getArguments());

        $request->setArguments(null);
        $this->assertNull($request->getArguments());
    }

    public function testSetId(): void
    {
        $request = new CallToolRequest('test_tool');

        $request->setId('custom_id');
        $this->assertSame('custom_id', $request->getId());

        $request->setId(12345);
        $this->assertSame(12345, $request->getId());
    }

    public function testSetIdWithInvalidType(): void
    {
        $request = new CallToolRequest('test_tool');

        $this->expectException(ValidationError::class);
        $request->setId(12.34);
    }

    public function testProgressToken(): void
    {
        $request = new CallToolRequest('test_tool');

        $this->assertFalse($request->hasProgressToken());
        $this->assertNull($request->getProgressToken());

        $request->setProgressToken('token_123');
        $this->assertTrue($request->hasProgressToken());
        $this->assertSame('token_123', $request->getProgressToken());

        $request->setProgressToken(456);
        $this->assertTrue($request->hasProgressToken());
        $this->assertSame(456, $request->getProgressToken());

        $request->setProgressToken(null);
        $this->assertFalse($request->hasProgressToken());
        $this->assertNull($request->getProgressToken());
    }

    public function testSetProgressTokenWithInvalidType(): void
    {
        $request = new CallToolRequest('test_tool');

        $this->expectException(ValidationError::class);
        $request->setProgressToken(12.34);
    }

    public function testGetParams(): void
    {
        $name = 'test_tool';
        $arguments = ['param' => 'value'];

        $request = new CallToolRequest($name, $arguments);

        $params = $request->getParams();
        $this->assertIsArray($params);
        $this->assertSame($name, $params['name']);
        $this->assertSame($arguments, $params['arguments']);
        $this->assertArrayNotHasKey('_meta', $params);
    }

    public function testGetParamsWithoutArguments(): void
    {
        $request = new CallToolRequest('test_tool');

        $params = $request->getParams();
        $this->assertIsArray($params);
        $this->assertSame('test_tool', $params['name']);
        $this->assertArrayNotHasKey('arguments', $params);
    }

    public function testGetParamsWithProgressToken(): void
    {
        $request = new CallToolRequest('test_tool');
        $request->setProgressToken('token_123');

        $params = $request->getParams();
        $this->assertArrayHasKey('_meta', $params);
        $this->assertSame('token_123', $params['_meta']['progressToken']);
    }

    public function testToJsonRpc(): void
    {
        $name = 'test_tool';
        $arguments = ['param' => 'value'];
        $id = 'call_123';

        $request = new CallToolRequest($name, $arguments, $id);

        $jsonRpc = $request->toJsonRpc();
        $this->assertSame('2.0', $jsonRpc['jsonrpc']);
        $this->assertSame($id, $jsonRpc['id']);
        $this->assertSame('tools/call', $jsonRpc['method']);
        $this->assertIsArray($jsonRpc['params']);
        $this->assertSame($name, $jsonRpc['params']['name']);
        $this->assertSame($arguments, $jsonRpc['params']['arguments']);
    }

    public function testFromArrayWithValidData(): void
    {
        $data = [
            'id' => 'call_123',
            'params' => [
                'name' => 'test_tool',
                'arguments' => ['param' => 'value'],
            ],
        ];

        $request = CallToolRequest::fromArray($data);

        $this->assertSame('call_123', $request->getId());
        $this->assertSame('test_tool', $request->getName());
        $this->assertSame(['param' => 'value'], $request->getArguments());
    }

    public function testFromArrayWithoutArguments(): void
    {
        $data = [
            'params' => [
                'name' => 'test_tool',
            ],
        ];

        $request = CallToolRequest::fromArray($data);

        $this->assertSame('test_tool', $request->getName());
        $this->assertNull($request->getArguments());
        $this->assertIsString($request->getId());
        $this->assertStringStartsWith('call_tool_', $request->getId());
    }

    public function testFromArrayMissingName(): void
    {
        $data = [
            'params' => [
                'arguments' => ['param' => 'value'],
            ],
        ];

        $this->expectException(ValidationError::class);
        CallToolRequest::fromArray($data);
    }
}
