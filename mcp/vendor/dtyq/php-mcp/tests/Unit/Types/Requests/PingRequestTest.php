<?php

declare(strict_types=1);
/**
 * Copyright (c) The Magic , Distributed under the software license
 */

namespace Dtyq\PhpMcp\Tests\Unit\Types\Requests;

use Dtyq\PhpMcp\Shared\Exceptions\ValidationError;
use Dtyq\PhpMcp\Types\Requests\PingRequest;
use PHPUnit\Framework\TestCase;

/**
 * Test case for PingRequest class.
 * @internal
 */
class PingRequestTest extends TestCase
{
    public function testConstructorWithId(): void
    {
        $id = 'ping_123';
        $request = new PingRequest($id);

        $this->assertSame('ping', $request->getMethod());
        $this->assertSame($id, $request->getId());
        $this->assertFalse($request->hasProgressToken());
        $this->assertNull($request->getProgressToken());
    }

    public function testConstructorWithAutoGeneratedId(): void
    {
        $request = new PingRequest();

        $this->assertIsString($request->getId());
        $this->assertStringStartsWith('ping_', $request->getId());
    }

    public function testSetId(): void
    {
        $request = new PingRequest();

        $request->setId('custom_ping');
        $this->assertSame('custom_ping', $request->getId());

        $request->setId(12345);
        $this->assertSame(12345, $request->getId());
    }

    public function testSetIdWithInvalidType(): void
    {
        $request = new PingRequest();

        $this->expectException(ValidationError::class);
        $request->setId(12.34);
    }

    public function testProgressToken(): void
    {
        $request = new PingRequest();

        $this->assertFalse($request->hasProgressToken());
        $this->assertNull($request->getProgressToken());

        $request->setProgressToken('token_123');
        $this->assertTrue($request->hasProgressToken());
        $this->assertSame('token_123', $request->getProgressToken());

        $request->setProgressToken(456);
        $this->assertTrue($request->hasProgressToken());
        $this->assertSame(456, $request->getProgressToken());

        $request->setProgressToken(null);
        $this->assertFalse($request->hasProgressToken());
        $this->assertNull($request->getProgressToken());
    }

    public function testSetProgressTokenWithInvalidType(): void
    {
        $request = new PingRequest();

        $this->expectException(ValidationError::class);
        $request->setProgressToken(12.34);
    }

    public function testGetParamsWithoutProgressToken(): void
    {
        $request = new PingRequest();

        $params = $request->getParams();
        $this->assertNull($params);
    }

    public function testGetParamsWithProgressToken(): void
    {
        $request = new PingRequest();
        $request->setProgressToken('token_123');

        $params = $request->getParams();
        $this->assertIsArray($params);
        $this->assertArrayHasKey('_meta', $params);
        $this->assertSame('token_123', $params['_meta']['progressToken']);
    }

    public function testToJsonRpc(): void
    {
        $id = 'ping_123';
        $request = new PingRequest($id);

        $jsonRpc = $request->toJsonRpc();
        $this->assertSame('2.0', $jsonRpc['jsonrpc']);
        $this->assertSame($id, $jsonRpc['id']);
        $this->assertSame('ping', $jsonRpc['method']);
        $this->assertArrayNotHasKey('params', $jsonRpc);
    }

    public function testFromArrayWithId(): void
    {
        $data = ['id' => 'ping_123'];

        $request = PingRequest::fromArray($data);

        $this->assertSame('ping_123', $request->getId());
    }

    public function testFromArrayWithoutId(): void
    {
        $data = [];

        $request = PingRequest::fromArray($data);

        $this->assertIsString($request->getId());
        $this->assertStringStartsWith('ping_', $request->getId());
    }
}
